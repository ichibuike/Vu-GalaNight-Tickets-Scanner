<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Concert Ticket QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDeeUgQQsHJLB0JTq8RHwlMPz2lSNl9T8k",
      authDomain: "qr-scanner-app-e3d83.firebaseapp.com",
      projectId: "qr-scanner-app-e3d83",
      storageBucket: "qr-scanner-app-e3d83.appspot.com",
      messagingSenderId: "976726923438",
      appId: "1:976726923438:web:0323093c6f8028afb9753f",
      measurementId: "G-PDP8G7QL71"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let scannedSet = new Set(JSON.parse(localStorage.getItem('scannedCodes') || '[]'));
    const scanLog = document.querySelector('#scan-log tbody');
    let counter = 1;

    function logScan(ticket) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${counter++}</td>
        <td>${ticket.name}</td>
        <td>${ticket.contact}</td>
        <td>${ticket.seat}</td>
        <td>${ticket.table}</td>
        <td>${new Date(ticket.timestamp).toLocaleString()}</td>
      `;
      scanLog.appendChild(row);
    }

    async function sendToFirestore(ticket) {
      // Check if ticket is already scanned in Firestore
      const q = query(collection(db, "scans"), where("code", "==", ticket.raw));
      const snap = await getDocs(q);

      if (!snap.empty) {
        alert("‚ö†Ô∏è This ticket has already been scanned!");
        return;
      }

      await addDoc(collection(db, "scans"), ticket);
      scannedSet.add(ticket.raw);
      localStorage.setItem('scannedCodes', JSON.stringify([...scannedSet]));
      logScan(ticket);
      document.getElementById('scan-result').textContent = `‚úÖ Scanned: ${ticket.name}`;
    }

    function parseQRCodeData(qrMessage) {
      const parts = qrMessage.split("|");
      if (parts.length !== 4) return null;
      return {
        raw: qrMessage,
        name: parts[0],
        contact: parts[1],
        seat: parts[2],
        table: parts[3],
        timestamp: new Date().toISOString()
      };
    }

    async function onScanSuccess(qrMessage) {
      if (scannedSet.has(qrMessage)) {
        alert("‚ö†Ô∏è Already scanned on this device!");
        return;
      }

      const ticket = parseQRCodeData(qrMessage);
      if (!ticket) {
        alert("‚ö†Ô∏è Invalid QR format!");
        return;
      }

      await html5QrCode.stop();
      await sendToFirestore(ticket);
      setTimeout(() => {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          onScanSuccess
        );
      }, 1500);
    }

    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          onScanSuccess
        );
      }
    });

    // Reload local history on load
    JSON.parse(localStorage.getItem('scannedCodes') || "[]").forEach(code => {
      const ticket = parseQRCodeData(code);
      if (ticket) logScan(ticket);
    });

    window.clearHistory = () => {
      localStorage.removeItem('scannedCodes');
      scannedSet.clear();
      scanLog.innerHTML = "";
      counter = 1;
      alert("üóëÔ∏è Local history cleared.");
    };
  </script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #1e1e2f, #3c3c58);
      padding: 20px;
      color: #fff;
      text-align: center;
    }
    .scanner-container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      color: #111;
      padding: 20px;
      border-radius: 10px;
      border: 2px dashed #111;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 15px;
      text-transform: uppercase;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
    #scan-result {
      margin-top: 10px;
      font-weight: bold;
      color: green;
    }
    .actions {
      margin-top: 20px;
    }
    .actions button {
      padding: 10px 15px;
      background: #111;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    #reader {
      max-width: 300px;
      margin: auto;
    }
  </style>
</head>
<body>
  <div class="scanner-container">
    <h2>Scan Concert Ticket</h2>
    <div id="reader"></div>
    <p id="scan-result"></p>

    <div class="actions">
      <button onclick="clearHistory()">üóëÔ∏è Clear Local History</button>
    </div>

    <table id="scan-log">
      <thead>
        <tr><th>#</th><th>Name</th><th>Contact</th><th>Seat</th><th>Table</th><th>Timestamp</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</body>
</html>
