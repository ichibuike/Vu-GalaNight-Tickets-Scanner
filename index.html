<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Concert Ticket QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #1e1e2f, #3c3c58);
      padding: 20px;
      text-align: center;
      color: #fff;
    }
    .scanner-container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      color: #111;
      padding: 20px;
      border-radius: 10px;
      border: 2px dashed #111;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
    h2 {
      font-size: 22px;
      font-weight: bold;
      text-transform: uppercase;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
      font-family: 'Courier New', Courier, monospace;
    }
    th {
      background-color: #e5e7eb;
    }
    #scan-result {
      font-weight: bold;
      margin-top: 10px;
      color: #0f0;
    }
    .actions {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .actions button {
      padding: 10px 15px;
      border: none;
      background-color: #111;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
    }
    @media (min-width: 600px) {
      .actions {
        flex-direction: row;
        justify-content: center;
      }
    }
    #reader {
      width: 100% !important;
      max-width: 300px;
      margin: auto;
    }
  </style>
</head>
<body>
  <div class="scanner-container">
    <h2>Scan Concert Ticket</h2>
    <div id="reader"></div>
    <p id="scan-result"></p>

    <div class="actions">
      <button onclick="clearHistory()">Clear History</button>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>

    <table id="scan-log">
      <thead>
        <tr><th>#</th><th>Data</th><th>Timestamp</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let scannedSet = new Set(JSON.parse(localStorage.getItem('scannedCodes')) || []);
    const scanLog = document.querySelector('#scan-log tbody');
    let counter = 1;

    function logScan(data, timeLabel = new Date().toLocaleString()) {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${counter++}</td><td>${data}</td><td>${timeLabel}</td>`;
      scanLog.appendChild(row);
    }

    function saveScanToLocalStorage(data) {
      scannedSet.add(data);
      localStorage.setItem('scannedCodes', JSON.stringify([...scannedSet]));
    }

function sendToGoogleSheet(data) {
  fetch('https://script.google.com/macros/s/AKfycb.../exec', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ code: data, timestamp: new Date().toISOString() })
  })
  .then(response => response.json())
  .then(result => {
    if (result.status === 'duplicate') {
      document.getElementById('scan-result').textContent = '⚠️ Already scanned (server)';
      document.getElementById('scan-result').style.color = '#f00';
    } else {
      logScan(data);
      saveScanToLocalStorage(data);
      document.getElementById('scan-result').textContent = `✅ Scanned: ${data}`;
      document.getElementById('scan-result').style.color = '#0f0';
    }
  })
  .catch(() => alert('⚠️ Network error. Check script deployment and permissions.'));
}

    function onScanSuccess(qrMessage) {
  if (scannedSet.has(qrMessage)) {
    alert('⚠️ This code has already been scanned on this device!');
    return;
  }

  // Immediately pause scanning
  html5QrCode.stop().then(() => {
    sendToGoogleSheet(qrMessage);

    // Restart scanning after 2 seconds
    setTimeout(() => {
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
      );
    }, 2000);
  }).catch(err => console.error('Error stopping scanner:', err));
}


    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          onScanSuccess
        );
      }
    });

    // Reload scanned entries
    JSON.parse(localStorage.getItem('scannedCodes') || "[]").forEach((entry, index) => {
      logScan(entry, "Previously Scanned");
      counter = index + 2;
    });

    function clearHistory() {
      localStorage.removeItem('scannedCodes');
      scannedSet.clear();
      scanLog.innerHTML = "";
      counter = 1;
      alert("🗑️ Local scan history cleared.");
    }

    function downloadCSV() {
      const rows = [["#", "Data", "Timestamp"]];
      const tableRows = scanLog.querySelectorAll("tr");
      tableRows.forEach(row => {
        const cells = row.querySelectorAll("td");
        const rowData = Array.from(cells).map(cell => cell.textContent);
        rows.push(rowData);
      });

      let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "scan_log.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
